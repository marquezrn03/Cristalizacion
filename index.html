<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cristal·lització: Fonaments, Disseny i Balanços</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-section { opacity: 0; animation: fadeIn 0.8s ease-out forwards; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; font-size: 0.875rem; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #0ea5e9; }
        input[type="number"], select { padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; width: 100%; }
        button, .styled-button-link { background-color: #38bdf8; color: #0c4a6e; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; display: inline-block; text-align: center; border: none; cursor: pointer;}
        button:hover, .styled-button-link:hover { background-color: #0ea5e9; }
        button:disabled { background-color: #bae6fd; cursor: not-allowed; }
        h1 { color: #111827; font-size: 1.875rem; line-height: 2.25rem; font-weight: 700;}
        h2 { color: #0c4a6e; font-size: 1.6rem; line-height: 2.1rem; font-weight: 700; border-bottom: 3px solid #7dd3fc; padding-bottom: 0.5rem; margin-top: 2.5rem; margin-bottom: 1.5rem; }
        h3 { color: #0369a1; font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid #bae6fd; padding-bottom: 0.25rem; }
        h4 { color: #075985; font-size: 1.1rem; line-height: 1.6rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem;}
        p, li { color: #374151; line-height: 1.75; margin-bottom: 1rem; }
        strong { color: #1F2937; font-weight: 600; }
        blockquote { border-left: 6px solid #fcd34d; padding: 1rem 1.5rem; margin: 2rem 0; font-style: italic; color: #374151; background-color: #fffbeb; border-radius: 0 0.5rem 0.5rem 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        blockquote.history { border-left-color: #a3e635; background-color: #f7fee7;}
        .section-bg-light { background-color: #f0f9ff; }
        .section-bg-white { background-color: #FFFFFF; }
        .instructional-text { font-size: 0.875rem; color: #4B5563; margin-top: 0.5rem; }
        .output-box { margin-top: 1rem; padding: 0.75rem; background-color: #e0f2fe; border: 1px solid #bae6fd; border-radius: 0.375rem; font-size: 0.875rem; color: #0369a1; text-align: center; font-weight: 500; min-height: 40px; }
        .slider-label-container { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
        .interactive-block { margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e0f2fe; border-radius: 0.5rem; background-color: #ffffff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .interactive-block-light { margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e0f2fe; border-radius: 0.5rem; background-color: #f0f9ff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        footer ul { list-style: none; padding-left: 0; }
        footer li { margin-bottom: 0.75rem; }
        footer a { color: #075985; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        .header-subtitle { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; margin-top: 0.25rem; }
        .header-attribution { font-size: 0.875rem; line-height: 1.25rem; margin-top: 0.5rem; opacity: 0.9; }
        .footer-attribution { margin-top: 1.5rem; font-size: 0.875rem; line-height: 1.25rem; color: #6b7280; text-align: center; }
        .plot-container { width: 100%; max-width: 550px; margin: 1rem auto; }
        .plot-svg .axis path, .plot-svg .axis line { fill: none; stroke: #6b7280; shape-rendering: crispEdges; }
        .plot-svg .axis text { font-size: 10px; fill: #4b5563; }
        .plot-svg .line { fill: none; stroke-width: 2px; }
        .plot-svg .solubility-line { stroke: #0ea5e9; }
        .plot-svg .supersaturation-line { stroke: #f59e0b; stroke-dasharray: 4,4; }
        .plot-svg .current-point { fill: #ef4444; stroke: #ffffff; stroke-width: 1px;}
        .plot-svg .zone-label { font-size: 10px; font-style: italic; fill: #6b7280; }
        .plot-svg .axis-label { font-size: 11px; fill: #374151; text-anchor: middle; }
        .nucleation-svg { display: block; margin: 1rem auto; width: 100%; max-width: 300px; height: 200px; border: 1px solid #bae6fd; background-color: #f0f9ff; border-radius: 0.25rem; }
        .nucleation-svg .nucleus { fill: #7dd3fc; opacity: 0.7; }
        .nucleation-svg .crystal { fill: #0369a1; opacity: 0.9; transition: r 0.3s ease; }
        .csd-plot-svg { display: block; margin: 0.5rem auto; width: 100%; max-width: 300px; height: 100px; }
        .csd-plot-svg .bar { fill: #38bdf8; }
        .crystallizer-diagram { display: flex; justify-content: center; align-items: center; background-color: #f0f9ff; border: 1px solid #bae6fd; padding: 1rem; border-radius: 0.5rem; min-height: 150px; }
        .crystallizer-diagram div { text-align: center; margin: 0 1rem; }
        .crystallizer-diagram .arrow { font-size: 1.5rem; color: #0ea5e9; margin: 0 0.5rem; }
        .crystallizer-diagram .label { font-size: 0.8rem; color: #0369a1; margin-top: 0.25rem; }
        .crystallizer-diagram .value { font-weight: 600; color: #0c4a6e; }
        .crystallizer-desc-block { border: 1px solid #e0f2fe; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #ffffff; }
        .placeholder-box { padding: 1rem; border: 1px dashed #7dd3fc; border-radius: 0.375rem; background-color: #f0f9ff; text-align: center; color: #075985; margin: 1.5rem 0; font-style: italic; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <header class="bg-gradient-to-r from-sky-600 to-cyan-600 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl md:text-3xl font-bold">Cristal·lització Industrial</h1>
            <p class="header-subtitle">Fonaments, Disseny i Balanços</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <section id="objectius" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.1 Objectius de la Cristal·lització</h2>
            <p>La cristal·lització és una operació de separació clau en què es forma una fase sòlida amb una estructura atòmica o molecular altament ordenada (cristall) a partir d'una fase fluida (dissolució, fusió, vapor). Els seus objectius principals són:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li><strong>Purificació:</strong> Explotant la tendència de la xarxa cristal·lina a excloure molècules diferents (impureses), la cristal·lització és un mètode potent per obtenir sòlids d'alta puresa.</li>
                <li><strong>Separació:</strong> Aïllament selectiu d'un component d'una mescla.</li>
                <li><strong>Control de Propietats del Producte Sòlid:</strong> Enginyeria de les propietats físiques del sòlid, fonamentals per al seu processament i aplicació:
                    <ul class="list-circle list-inside pl-6 mt-2">
                        <li><strong>Distribució de Mida de Cristall (CSD):</strong> Afecta filtració, assecat, fluïdesa, dissolució, biodisponibilitat.</li>
                        <li><strong>Morfologia (Hàbit):</strong> Influencia l'empaquetament, propietats mecàniques, aspecte.</li>
                        <li><strong>Polimorfisme i Solvats/Hidrats:</strong> Control de la forma cristal·lina específica, cadascuna amb propietats termodinàmiques i cinètiques diferents.</li>
                    </ul>
                </li>
            </ul>
            <blockquote class="history">La comprensió termodinàmica de la cristal·lització deu molt a J.W. Gibbs (finals s. XIX), qui va establir les bases de l'equilibri de fases i el potencial químic com a força impulsora.</blockquote>
        </section>

        <section id="tipus-cristalitzadors" class="mb-12 p-6 rounded-lg shadow-lg section-bg-light dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.2 Tipus de Cristal·litzadors i Equips</h2>
            <p>L'elecció del cristal·litzador és una decisió d'enginyeria crucial que depèn de la termodinàmica (corba de solubilitat), la cinètica (nucleació, creixement), les propietats del fluid (viscositat), la tendència a l'embrutiment (fouling/incrustació), l'escala i les especificacions del producte (CSD, puresa, polimorf).</p>

            <h3>Classificació Principal:</h3>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li><strong>Generació de Sobresaturació:</strong> Refredament (Cooling), Evaporació (Evaporative), Refredament Evaporatiu (Vacuum Cooling), Antidissolvent (Antisolvent/Precipitation), Reacció Química (Reactive Crystallization).</li>
                <li><strong>Mode d'Operació:</strong> Discontinu (Batch), Continu (Continuous), Semi-continu (Semi-Batch).</li>
            </ul>

            <h3>Dissenys Industrials Comuns (Continua):</h3>
            <div class="crystallizer-desc-block">
                 <h4 class="text-lg font-semibold mb-3 text-sky-700">Cristal·litzador MSMPR (Mixed Suspension, Mixed Product Removal) / Circulació Forçada (FC)</h4>
                 <ul class="list-disc list-inside text-sm pl-4 space-y-1">
                     <li><strong>Principi:</strong> Idealització d'un tanc perfectament agitat (CSTR) on la suspensió (cristalls + licor) s'extreu de forma representativa. La circulació forçada externa (FC) amb intercanviador permet un bon control de T i redueix incrustacions a les superfícies de transferència de calor.</li>
                     <li><strong>Característiques:</strong> Disseny relativament simple i econòmic. L'agitació intensa manté la suspensió homogènia però afavoreix la nucleació secundària per contacte i el trencament (attrition). La CSD resultant és típicament ampla i segueix una distribució exponencial teòrica. Control limitat sobre la CSD.</li>
                     <li><strong>Aplicacions:</strong> Producció a gran escala on una CSD ampla és acceptable (ex: fertilitzants com (NH₄)₂SO₄, KCl).</li>
                 </ul>
            </div>
             <div class="crystallizer-desc-block">
                 <h4 class="text-lg font-semibold mb-3 text-sky-700">Cristal·litzador DTB (Draft Tube Baffle)</h4>
                 <ul class="list-disc list-inside text-sm pl-4 space-y-1">
                     <li><strong>Principi:</strong> Tanc agitat amb un tub central (draft tube) per a la circulació interna controlada (impulsada per un agitador intern o extern) i una zona de sedimentació anular (separada per un deflector o baffle).</li>
                     <li><strong>Característiques:</strong> Permet la classificació interna: els cristalls grans sedimenten a la zona anular i s'extreuen pel fons, mentre que els fins són recirculats o extrets selectivament de la zona superior clara (eliminació/destrucció de fins). Això permet operar a menor sobresaturació a la zona de creixement, reduir la nucleació secundària i obtenir una CSD més estreta i cristalls més grans que en un MSMPR. Sovint usat en cristal·lització per buit (refredament evaporatiu).</li>
                     <li><strong>Aplicacions:</strong> Producció de sals inorgàniques (NaCl, Na₂SO₄), sucre, on es busca un millor control de la CSD.</li>
                 </ul>
            </div>
             <div class="crystallizer-desc-block">
                 <h4 class="text-lg font-semibold mb-3 text-sky-700">Cristal·litzador OSLO (Krystal) / Llit Fluiditzat</h4>
                 <ul class="list-disc list-inside text-sm pl-4 space-y-1">
                     <li><strong>Principi:</strong> Cristal·litzador de classificació on la sobresaturació es genera externament (escalfant/evaporant i després refredant lleugerament el licor clar recirculat) i s'introdueix per la part inferior d'una cambra on fluiditza un llit de cristalls.</li>
                     <li><strong>Característiques:</strong> Separació física de les zones de generació de sobresaturació/nucleació (externa o a la part superior) i de creixement (llit fluiditzat). Permet un control molt fi de la sobresaturació en el llit (\(\approx\) MSZW), minimitzant la nucleació i maximitzant el creixement sobre els cristalls existents. Produeix cristalls grans amb CSD molt estreta. Requereix un bon control hidrodinàmic per mantenir la fluidització estable.</li>
                     <li><strong>Aplicacions:</strong> Producció de cristalls grans i d'alta uniformitat (ex: NaCl de grau alimentari, (NH₄)₂SO₄, KNO₃, ADP).</li>
                 </ul>
            </div>
            <blockquote class="history">El disseny de cristal·litzadors industrials va experimentar un gran avenç amb els treballs de Swenson i Walker (cristal·litzador OSLO/Krystal) i la formalització del concepte MSMPR per Randolph i Larson a la dècada de 1960, que va permetre aplicar els Balanços de Població.</blockquote>
        </section>

        <section id="nucleacio-creixement" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.3 Nucleació i Creixement. Població de Cristalls.</h2>
            <p>La formació de cristalls és un procés cinètic governat per la sobresaturació (\( \sigma = (C - C_{sat})/C_{sat} \)), que actua com a força impulsora tant per a la nucleació com per al creixement.</p>

            <h4>Nucleació (B): Formació de Nous Cristalls</h4>
            <p>Basada en la Teoria Clàssica de Nucleació (CNT), la formació d'un nucli de mida crítica (\(r^*\)) requereix superar una barrera energètica (\(\Delta G^*\)).</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li><strong>Primària (Homogènia/Heterogènia):</strong> Formació de nuclis en absència de cristalls propis. La velocitat depèn exponencialment de la sobresaturació: \(B \propto \exp(-\frac{K}{\sigma^2})\). La heterogènia (sobre impureses/superfícies) domina sobre l'homogènia (en el si del fluid) per tenir una barrera energètica menor.</li>
                <li><strong>Secundària:</strong> Induïda per la presència de cristalls propis. És el mecanisme dominant a nivell industrial. La velocitat sol seguir una llei potencial: \(B_{sec} = k_b \sigma^b M_T^j \epsilon^k\), on \(b\) (ordre respecte a \(\sigma\)) sol ser ~1-3, \(M_T\) és la densitat de suspensió (impacte dels cristalls, ordre \(j \approx 1\)), i \(\epsilon\) és la dissipació d'energia per agitació (impacte de col·lisions, ordre \(k \approx 0.5-1\)).</li>
            </ul>

            <h4>Creixement Cristal·lí (G): Augment de Mida</h4>
            <p>La velocitat lineal de creixement (\(G = dL/dt\)) també depèn de la sobresaturació, sovint segons \(G = k_g \sigma^g\), amb \(g\) (ordre respecte a \(\sigma\)) típicament entre 1 i 2. El procés pot estar limitat per:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li><strong>Difusió Externa:</strong> Transport de massa a través de la capa límit. \(G \propto \Delta C\).</li>
                <li><strong>Integració Superficial:</strong> Processos a la interfície (adsorció, migració, incorporació). Segons models com BCF (Burton, Cabrera, Frank), pot dependre de \(\sigma\) o \(\sigma^2\).</li>
            </ul>
            <p>La velocitat global ve determinada pel pas més lent. Impureses poden inhibir el creixement (enverinament).</p>

            <h4>Distribució de Mida de Cristall (CSD) i Balanç de Població (PBE)</h4>
            <p>La CSD (\(n(L)\)) és el resultat de la competència entre B i G. El Balanç de Població (PBE) descriu matemàticament l'evolució de \(n(L,t)\). Per a un MSMPR continu i estacionari, sense aglomeració ni trencament i amb G independent de L:</p>
            $$ \frac{dn}{dt} = 0 = B \delta(L-L_0) - \frac{d(G n)}{dL} - \frac{n}{\tau} $$
            <p>La solució és \(n(L) = n^0 \exp(-L / (G\tau))\), on \(n^0 = B/G\). Controlar la CSD implica manipular B i G a través de la sobresaturació, temperatura, agitació, temps de residència (\(\tau\)), etc.</p>

             <div class="interactive-block">
                 <h4 class="text-lg font-semibold mb-3 text-center text-sky-700">Simulador Conceptual Nucleació vs. Creixement i CSD</h4>
                 <p class="instructional-text text-center mb-4">Ajusta la sobresaturació i l'agitació per veure l'efecte conceptual sobre la nucleació (nous punts), el creixement (mida dels punts) i la forma de la CSD.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="nucl-supersat-slider">Sobresaturació (\(\sigma\), relatiu):</label>
                         <input type="range" id="nucl-supersat-slider" min="1" max="100" value="50" step="1">
                         <div class="slider-label-container"><span>Baixa</span><span id="nucl-supersat-value">50</span><span>Alta</span></div>
                     </div>
                     <div>
                         <label for="nucl-agitation-slider">Agitació/Nucl. Secundària:</label>
                         <input type="range" id="nucl-agitation-slider" min="0" max="100" value="30" step="1">
                         <div class="slider-label-container"><span>Baixa</span><span id="nucl-agitation-value">30</span><span>Alta</span></div>
                     </div>
                 </div>
                 <div class="flex flex-col md:flex-row gap-4 items-center">
                     <div class="nucleation-svg-container flex-1">
                         <svg id="nucleation-svg" class="nucleation-svg"></svg>
                     </div>
                     <div class="csd-plot-container flex-1">
                          <svg id="csd-plot-svg" class="csd-plot-svg" viewBox="0 0 300 100"></svg>
                     </div>
                 </div>
                 <div id="nucleation-output" class="output-box">Procés: Mixt. CSD: Moderada.</div>
             </div>
        </section>

        <section id="corbes-solubilitat" class="mb-12 p-6 rounded-lg shadow-lg section-bg-light dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.4 Corbes de Solubilitat i Sobresaturació</h2>
            <p>La <strong>solubilitat</strong> (\(C_{sat}\) o \(x_{sat}\)) defineix l'equilibri termodinàmic sòlid-líquid. La seva dependència amb la temperatura (corba de solubilitat) dicta l'estratègia principal per generar sobresaturació.</p>
            <p>La <strong>sobresaturació</strong> (\(\sigma = S-1\)) és la força impulsora cinètica. La regió entre la corba de solubilitat (\(S=1\)) i el límit on la nucleació primària és ràpida (límit metaestable superior) és la <strong>Zona Metaestable (MSZ)</strong>. Operar dins la MSZ afavoreix el creixement sobre la nucleació.</p>
            <p>L'amplada de la zona metaestable (MSZW) és un paràmetre cinètic crucial, influenciat per:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li>Velocitat de canvi de condicions (refredament, evaporació).</li>
                <li>Nivell d'agitació (augmenta nucleació secundària).</li>
                <li>Presència d'impureses (poden actuar com a nuclis heterogenis o inhibidors).</li>
                <li>Presència de cristalls (sembra, nucleació secundària).</li>
            </ul>
            <blockquote class="history">El concepte de zona metaestable i la seva importància pràctica van ser clarificats per Miers al voltant de 1906, observant que la nucleació espontània requeria un cert grau de "superrefredament" (sobresaturació) per sota de la corba de solubilitat.</blockquote>

            <div class="interactive-block-light">
                 <h4 class="text-lg font-semibold mb-3 text-center text-sky-700">Explorador de Corba de Solubilitat i MSZW</h4>
                 <p class="instructional-text text-center mb-4">Fes clic al gràfic o ajusta els sliders per explorar les zones de cristal·lització.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="solub-temp-slider">Temperatura (°C): <span id="solub-temp-value">40</span></label>
                         <input type="range" id="solub-temp-slider" min="0" max="100" value="40" step="1">
                     </div>
                     <div>
                         <label for="solub-conc-slider">Concentració (g solut / 100g solv.): <span id="solub-conc-value">30</span></label>
                         <input type="range" id="solub-conc-slider" min="0" max="80" value="30" step="1">
                     </div>
                 </div>
                  <div id="solubility-plot-container" class="plot-container bg-white rounded shadow-inner p-2 cursor-crosshair">
                     <svg id="solubility-plot-svg" class="plot-svg" width="500" height="350"></svg>
                 </div>
                 <div id="solubility-output" class="output-box">Zona: Estable (No Saturada). ΔC ≈ -5.0 g/100g</div>
            </div>

             <div class="interactive-block">
                 <h4 class="text-lg font-semibold mb-3 text-center text-sky-700">Efecte de la Velocitat de Refredament (Conceptual)</h4>
                 <p class="instructional-text text-center mb-4">Ajusta la velocitat de refredament per veure el seu impacte conceptual en la nucleació vs creixement i la CSD resultant.</p>
                 <div class="mb-4 px-4">
                     <label for="cooling-rate-slider">Velocitat de Refredament:</label>
                     <input type="range" id="cooling-rate-slider" min="0" max="100" value="50" step="1">
                     <div class="slider-label-container"><span>Lenta</span><span id="cooling-rate-value">50</span><span>Ràpida</span></div>
                 </div>
                 <div class="flex flex-col md:flex-row gap-4 items-center">
                     <div class="nucleation-svg-container flex-1">
                         <svg id="cooling-nucleation-svg" class="nucleation-svg"></svg>
                     </div>
                     <div class="csd-plot-container flex-1">
                          <svg id="cooling-csd-plot-svg" class="csd-plot-svg" viewBox="0 0 300 100"></svg>
                     </div>
                 </div>
                 <div id="cooling-output" class="output-box">Resultat: Balanç nucleació/creixement. CSD: Moderada.</div>
             </div>

        </section>

        <section id="rendiment" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.5 Rendiment i Eficàcia de Cristal·lització</h2>
            <p>El <strong>rendiment</strong> (\(Y\)) d'una operació de cristal·lització quantifica la fracció màssica del solut inicialment present a l'alimentació que es recupera com a producte cristal·lí sòlid. És un indicador clau de l'eficiència de la separació.</p>
            <p>L'<strong>Eficàcia de Cristal·lització</strong> (\(\eta\)) sol expressar-se en percentatge:</p>
            $$ \eta (\%) = Y \times 100 = \frac{\text{Massa de solut (anhidre) en els cristalls}}{\text{Massa de solut (anhidre) a l'alimentació}} \times 100 $$
            <p>El càlcul es basa en els balanços de matèria. Si \(C\) és la massa de cristalls produïts i \(F\) la massa d'alimentació, i \(x_C^{anh}\) i \(x_F^{anh}\) són les fraccions màssiques de solut anhidre en els cristalls i l'alimentació respectivament:</p>
            $$ Y = \frac{C \cdot x_C^{anh}}{F \cdot x_F^{anh}} $$
            <p>Cal tenir en compte que si els cristalls són hidrats, \(x_C^{anh} = \frac{PM_{solut}}{PM_{hidrat}}\) i és menor que 1. El rendiment màxim teòric (\(Y_{max}\)) ve determinat per la solubilitat residual en el licor mare (\(x_M = x_{sat}(T_{final})\)). Per a un procés simple de refredament sense evaporació i cristalls anhidres (\(x_C^{anh}=1\)):</p>
            $$ Y_{max} = \frac{F \cdot x_F - M \cdot x_M}{F \cdot x_F} = \frac{x_F - x_M}{x_F(1 - x_M)} $$
            <p>(Aquesta última expressió s'obté combinant balanç global i de solut). Factors com l'evaporació, la formació d'hidrats i les pèrdues mecàniques redueixen el rendiment real respecte al teòric.</p>
        </section>

        <section id="calcul" class="mb-12 p-6 rounded-lg shadow-lg section-bg-light dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.6 Càlcul d’un Cristal·litzador</h2>
            <p>El disseny rigorós i l'anàlisi de l'operació d'un cristal·litzador es basen en l'aplicació dels principis d'equilibri de fases i els balanços de conservació de matèria i energia.</p>

            <h3 class="text-xl font-semibold">6.6.1 Diagrama de Fases</h3>
            <p>Els diagrames T-composició són indispensables per entendre l'equilibri sòlid-líquid. Permeten identificar:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li>Corbes de solubilitat de les diferents fases sòlides estables (anhidres, hidrats).</li>
                <li>Punts invariant (eutèctics, peritèctics, punts de transició) on coexisteixen tres fases en equilibri.</li>
                <li>Regions monofàsiques (dissolució insaturada) i bifàsiques (dissolució saturada + sòlid).</li>
                <li>Punts de fusió congruent (el sòlid fon a un líquid de la mateixa composició) i incongruent (el sòlid es descompon en un altre sòlid i líquid en escalfar-se).</li>
                <li>Possibles regions de formació de solucions sòlides.</li>
            </ul>
             <blockquote class="history">L'aplicació sistemàtica dels diagrames de fases a problemes industrials, inclosa la cristal·lització, va ser impulsada per treballs com els de Roozeboom a finals del segle XIX i principis del XX, basats en la regla de les fases de Gibbs.</blockquote>
            <p>La <strong>Regla de la Palanca</strong>, aplicada a les regions bifàsiques, permet calcular les proporcions relatives de fase líquida (M, amb composició \(x_M\)) i sòlida (C, amb composició \(x_C\)) en equilibri per a una mescla global de composició \(x_F\):</p>
            $$ \frac{M}{C} = \frac{x_C - x_F}{x_F - x_M} \quad \text{o bé} \quad M(x_F - x_M) = C(x_C - x_F) $$

            <h3 class="text-xl font-semibold">6.6.2 Diagrama d’Entalpia-Concentració</h3>
            <p>Aquests diagrames (tipus Merkel o Ponchon-Savarit adaptat) representen l'entalpia específica (\(H\), kJ/kg mescla total) en funció de la fracció màssica de solut (\(x\)), generalment a pressió constant. Són crucials per als balanços d'energia.</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li>Mostren isotermes a la regió líquida insaturada.</li>
                <li>La corba de saturació separa la regió líquida de les regions bifàsiques.</li>
                <li>A les regions bifàsiques (L+S), les isotermes són línies rectes (línies d'unió o tie-lines) que connecten l'entalpia del líquid saturat amb la del sòlid en equilibri a aquesta temperatura. La regla de la palanca també s'hi aplica per trobar l'entalpia d'una mescla.</li>
                <li>Permeten llegir directament les entalpies de les corrents si es coneixen T i x.</li>
                <li>Visualitzen la calor de dissolució i la calor de cristal·lització (diferència d'entalpia entre la dissolució i les fases separades).</li>
            </ul>
             <p class="my-6 p-4 border border-dashed border-gray-300 rounded bg-white text-center text-gray-600 italic">
                 Referència a Figura PPT: Diagrama Entalpia-Concentració (MgSO₄–H₂O).
            </p>

            <h3 class="text-xl font-semibold">6.6.3 Balanços de Matèria i Energia</h3>
            <p>Per a un cristal·litzador continu operant en estat estacionari:</p>
            <p><strong>Balanç Global de Matèria:</strong> \( F = M + V + C \)</p>
            <p><strong>Balanç de Solut (anhidre):</strong> \( F x_F^{anh} = M x_M^{anh} + C x_C^{anh} + V x_V^{anh} \)</p>
            <p>(Normalment \(x_V^{anh} = 0\). \(x_M^{anh}\) és la fracció màssica de solut anhidre en el licor mare, que correspon a la solubilitat a \(T_{sortida}\) expressada en base anhidra. \(x_C^{anh}\) és la fracció màssica de solut anhidre en els cristalls).</p>
            <p><strong>Balanç de Dissolvent (o component inert):</strong> \( F (1-x_F^{anh}) = M (1-x_M^{anh}) + C (1-x_C^{anh}) + V (1-x_V^{anh}) \)</p>
            <p>(Normalment \(1-x_V^{anh} = 1\)). Aquests balanços permeten calcular C i M (i V si hi ha evaporació).</p>

            <div class="interactive-block-light">
                 <h4 class="text-lg font-semibold mb-3 text-center text-sky-700">Calculadora de Balanç de Matèria (Refredament Simple)</h4>
                 <p class="instructional-text text-center mb-4">Estima la producció de cristalls i el rendiment per a un cristal·litzador per refredament simple (sense evaporació).</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="mass-F-slider">Alimentació (F, kg): <span id="mass-F-value">1000</span></label>
                         <input type="range" id="mass-F-slider" min="100" max="10000" value="1000" step="100">
                     </div>
                     <div>
                         <label for="mass-xF-slider">Conc. Alim. (xF, % pes solut anhidre): <span id="mass-xF-value">40</span></label>
                         <input type="range" id="mass-xF-slider" min="10" max="60" value="40" step="1">
                     </div>
                     <div>
                         <label for="mass-xM-slider">Solubilitat Final (xM, % pes solut anhidre): <span id="mass-xM-value">20</span></label>
                         <input type="range" id="mass-xM-slider" min="5" max="35" value="20" step="1">
                     </div>
                     <div>
                         <label for="mass-xC-input">Conc. Cristal (xC, % pes solut anhidre):</label>
                         <input type="number" id="mass-xC-input" value="100" step="1" min="10" max="100" class="w-full">
                         <p class="instructional-text text-xs">Ex: 100 per anhidre, ~48.8 per MgSO₄·7H₂O.</p>
                     </div>
                 </div>
                 <div id="mass-balance-output" class="output-box">Cristalls (C): 250.0 kg | Licor Mare (M): 750.0 kg | Eficàcia: 62.5%</div>
                 <div id="lever-rule-vis" class="mt-4 text-center instructional-text">Regla Palanca: M/C = 0.600 / 0.200 ≈ 3.00</div>
            </div>

            <p><strong>Balanç d'Energia (Entalpia):</strong></p>
            $$ \sum_{in} F_i H_i + Q_{in} = \sum_{out} F_j H_j + Q_{out} + W_s $$
            <p>Per a un cristal·litzador per refredament continu sense evaporació (\(V=0\), \(Q_{in}=0\), \(W_s \approx 0\)):</p>
            $$ F H_F = M H_M + C H_C + Q_{out} $$
            <p>La càrrega tèrmica a retirar (\(Q_{out}\)) es calcula a partir de les entalpies específiques llegides del diagrama H-x o calculades a partir de calors específiques (\(C_p\)) i calor latent de cristal·lització (\(\Delta H_{crist}\), que és negativa per a processos exotèrmics).</p>
             <blockquote class="history">Els balanços de matèria i energia aplicats a operacions unitàries van ser sistematitzats per pioners de l'enginyeria química com McCabe, Thiele i altres a mitjans del segle XX, formant la base de l'anàlisi de processos.</blockquote>

            <div class="interactive-block-light">
                 <h4 class="text-lg font-semibold mb-3 text-center text-sky-700">Visualitzador Conceptual Balanç d'Energia (Refredament)</h4>
                 <p class="instructional-text text-center mb-4">Ajusta els paràmetres per estimar conceptualment la càrrega de refredament requerida.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="energy-F-slider">Cabal Alimentació (F, conceptual):</label>
                         <input type="range" id="energy-F-slider" min="10" max="100" value="50" step="1">
                         <div class="slider-label-container"><span>Baix</span><span id="energy-F-value">50</span><span>Alt</span></div>
                     </div>
                     <div>
                         <label for="energy-Tin-slider">Temp. Alimentació (Tin, °C):</label>
                         <input type="range" id="energy-Tin-slider" min="30" max="90" value="60" step="1">
                         <div class="slider-label-container"><span>30</span><span id="energy-Tin-value">60</span><span>90</span></div>
                     </div>
                     <div>
                         <label for="energy-Tout-slider">Temp. Cristalls (Tout, °C):</label>
                         <input type="range" id="energy-Tout-slider" min="0" max="40" value="20" step="1">
                         <div class="slider-label-container"><span>0</span><span id="energy-Tout-value">20</span><span>40</span></div>
                     </div>
                     <div>
                         <label for="energy-Hcryst-slider">Calor Cristal·lització (\(-\Delta H_{crist}\), conceptual):</label>
                         <input type="range" id="energy-Hcryst-slider" min="10" max="100" value="50" step="1">
                         <div class="slider-label-container"><span>Baix (Exo)</span><span id="energy-Hcryst-value">50</span><span>Alt (Exo)</span></div>
                     </div>
                 </div>
                 <div class="crystallizer-diagram">
                     <div>
                         <span class="label">Alimentació (F, Tin)</span>
                         <div class="value" id="energy-feed-display">50 @ 60°C</div>
                     </div>
                     <div class="arrow">➔</div>
                     <div>
                         <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M12 16V8"></path><path d="m15 13-3-3-3 3"></path></svg>
                         <span class="label">Cristal·litzador</span>
                         <div class="value text-red-600" id="energy-qout-display">Q<sub>retirada</sub> ≈ 3000</div>
                     </div>
                     <div class="arrow">➔</div>
                      <div>
                         <span class="label">Cristalls (C, Tout)</span>
                         <div class="value" id="energy-crystal-display">~20 @ 20°C</div>
                         <span class="label mt-2">Licor (M, Tout)</span>
                         <div class="value" id="energy-liquor-display">~30 @ 20°C</div>
                     </div>
                 </div>
                 <div id="energy-balance-output" class="output-box">Càrrega de Refredament (Q) estimada: Mitjana-Alta</div>
            </div>
        </section>

        <section id="aplicacions" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-sky-700 border-b-2 border-sky-200 pb-2 mb-6">6.7 Aplicacions Industrials</h2>
            <p>La cristal·lització és una operació unitària ubiqua en nombroses indústries:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li><strong>Indústria Alimentària:</strong> Producció de sucre (sacarosa), sal (NaCl), lactosa, àcid cítric, glutamat monosòdic, edulcorants (xilitol). Controlar la mida del cristall és clau per a la textura i la solubilitat.</li>
                <li><strong>Indústria Farmacèutica:</strong> Purificació d'Ingredients Farmacèutics Actius (APIs), control de polimorfisme (diferents formes cristal·lines amb distinta biodisponibilitat), producció d'excipients. La CSD i la forma cristal·lina són crítiques.</li>
                <li><strong>Indústria Química i Petroquímica:</strong> Producció de sals inorgàniques (sulfat d'amoni, nitrat de potassi, carbonat de sodi), àcids orgànics (adípic, tereftàlic), separació d'isòmers (p-xilè), purificació de productes intermedis.</li>
                <li><strong>Tractament d'Aigües i Efluents:</strong> Recuperació de sals valuoses (ex. sulfat de sodi d'efluents de viscosa), eliminació de sals per reduir la salinitat.</li>
                <li><strong>Mineria i Metal·lúrgia:</strong> Recuperació de sals metàl·liques (sulfat de coure, níquel), purificació d'alúmina.</li>
                <li><strong>Bioprocessos:</strong> Cristal·lització de proteïnes, aminoàcids i altres productes biotecnològics per a purificació i formulació.</li>
            </ul>
            <p>El disseny i operació òptims del procés de cristal·lització són essencials per obtenir productes amb la qualitat requerida i assegurar l'eficiència econòmica del procés global.</p>
        </section>
<section class="mt-12 text-center grid grid-cols-2 gap-4">
            <a href="https://marquezrn03.github.io/Cristalizacion/Ej2.html" class="styled-button-link"> Next: Condensador de Superficie</a>
        </section>
     <footer class="mt-16 pt-8 border-t border-gray-300 text-sm text-gray-600">
         <p class="footer-attribution">Curs de Cristal·lització</p>
         <p class="footer-attribution">Developed by ronald.marquez@udg.edu / Powered by Gemini 2.5</p>
     </footer>
    </main>

    <script>
        const sections_cryst_all = document.querySelectorAll('.fade-in-section');
        const observerOptions_cryst_all = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observerCallback_cryst_all = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in-section');
                    observer.unobserve(entry.target);
                }
            });
        };
        const observer_cryst_all = new IntersectionObserver(observerCallback_cryst_all, observerOptions_cryst_all);
        sections_cryst_all.forEach(section => { observer_cryst_all.observe(section); });

        const crystTabButtons = document.querySelectorAll('#crystallizer-tabs .tab-button');
        const crystTabContents = document.querySelectorAll('#crystallizer-content > div');

        function showTab(tabId) {
            crystTabContents.forEach(content => {
                const isActive = content.id === tabId;
                content.classList.toggle('active', isActive);
                content.style.display = isActive ? 'block' : 'none';
            });
            crystTabButtons.forEach(button => {
                button.classList.toggle('active', button.getAttribute('onclick').includes(`'${tabId}'`));
            });
        }
        if (crystTabButtons.length > 0) {
            crystTabButtons.forEach(button => button.addEventListener('click', () => showTab(button.getAttribute('onclick').match(/'([^']+)'/)[1])));
            if(crystTabContents.length > 0) showTab(crystTabContents[0].id);
        }

        const solubTempSlider = document.getElementById('solub-temp-slider');
        const solubConcSlider = document.getElementById('solub-conc-slider');
        const solubTempValue = document.getElementById('solub-temp-value');
        const solubConcValue = document.getElementById('solub-conc-value');
        const solubilityPlotSvg = d3.select("#solubility-plot-svg");
        const solubilityOutput = document.getElementById('solubility-output');
        const solubilityPlotContainer = document.getElementById('solubility-plot-container');

        function solubilityCurve(T) { return 10 + 0.5 * T; }
        function supersaturationCurve(T) { return 15 + 0.55 * T; }

        function renderSolubilityPlot() {
            if (!solubTempSlider || !solubConcSlider || !solubTempValue || !solubConcValue || solubilityPlotSvg.empty() || !solubilityOutput) return;
            const T_current = parseFloat(solubTempSlider.value);
            const C_current = parseFloat(solubConcSlider.value);
            solubTempValue.textContent = T_current.toFixed(0);
            solubConcValue.textContent = C_current.toFixed(0);

            const svgNode = solubilityPlotSvg.node();
            if (!svgNode) return;
            const width = svgNode.closest('.plot-container')?.getBoundingClientRect().width || 500;
            const height = 350;
            const margin = {top: 20, right: 20, bottom: 50, left: 60};
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            solubilityPlotSvg.selectAll("*").remove();
            solubilityPlotSvg.attr('viewBox', `0 0 ${width} ${height}`);
            const g = solubilityPlotSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const Tmin = 0, Tmax = 100, Cmin = 0, Cmax = 80;
            const xScale = d3.scaleLinear().domain([Tmin, Tmax]).range([0, plotWidth]);
            const yScale = d3.scaleLinear().domain([Cmin, Cmax]).range([plotHeight, 0]);

            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);
            g.append("g").attr("transform", `translate(0,${plotHeight})`).call(xAxis);
            g.append("g").call(yAxis);
            g.append("text").attr("transform", `translate(${plotWidth / 2}, ${plotHeight + margin.bottom - 10})`).attr("class", "axis-label").text("Temperatura (°C)");
            g.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left + 15).attr("x", 0 - (plotHeight / 2)).attr("dy", "0em").attr("class", "axis-label").text("Concentració (g/100g solv.)");

            const lineData = d3.range(Tmin, Tmax + 1, 1).map(t => ({temp: t, sat: solubilityCurve(t), supersat: supersaturationCurve(t)}));
            const solLine = d3.line().x(d => xScale(d.temp)).y(d => yScale(d.sat));
            const supersatLine = d3.line().x(d => xScale(d.temp)).y(d => yScale(d.supersat));

            g.append("path").datum(lineData).attr("class", "line solubility-line").attr("d", solLine).attr("stroke", "#0ea5e9");
            g.append("path").datum(lineData).attr("class", "line supersaturation-line").attr("d", supersatLine).attr("stroke", "#f59e0b");

            g.append("text").attr("x", xScale(85)).attr("y", yScale(solubilityCurve(85)) - 5).attr("class", "plot-svg zone-label").text("Solubilitat").style("fill", "#0ea5e9");
            g.append("text").attr("x", xScale(85)).attr("y", yScale(supersaturationCurve(85)) - 5).attr("class", "plot-svg zone-label").text("Límit Metaestable").style("fill", "#f59e0b");
            g.append("text").attr("x", xScale(50)).attr("y", yScale(15)).attr("class", "plot-svg zone-label").text("Zona Estable").style("font-weight", "bold");
            g.append("text").attr("x", xScale(50)).attr("y", yScale(35)).attr("class", "plot-svg zone-label").text("Zona Metaestable").style("font-weight", "bold");
            g.append("text").attr("x", xScale(50)).attr("y", yScale(65)).attr("class", "plot-svg zone-label").text("Zona Làbil").style("font-weight", "bold");


            const currentX = xScale(T_current);
            const currentY = yScale(C_current);
            const satC = solubilityCurve(T_current);
            const supersatC = supersaturationCurve(T_current);
            let zone = "";
            let deltaC = C_current - satC;

            if (C_current < satC) { zone = "Estable (No Saturada)"; }
            else if (C_current >= satC && C_current < supersatC) { zone = "Metaestable (Creixement > Nucleació)"; }
            else { zone = "Làbil (Nucleació > Creixement)"; }

            g.append("circle").attr("cx", currentX).attr("cy", currentY).attr("r", 5).attr("class", "current-point");
            g.append("text").attr("x", currentX + 8).attr("y", currentY + 4).attr("class", "plot-svg zone-label").style("font-weight", "bold").style("fill", "#ef4444").text(`(${T_current.toFixed(0)}°C, ${C_current.toFixed(0)}g)`);

            solubilityOutput.textContent = `Zona: ${zone}. ΔC ≈ ${deltaC.toFixed(1)} g/100g`;
        }

        function updateFromPlotClick(event) {
            if (!solubilityPlotSvg.empty()) {
                const svgNode = solubilityPlotSvg.node();
                const margin = {top: 20, right: 20, bottom: 50, left: 60};
                const width = svgNode.closest('.plot-container')?.getBoundingClientRect().width || 500;
                const height = 350;
                const plotWidth = width - margin.left - margin.right;
                const plotHeight = height - margin.top - margin.bottom;
                const Tmin = 0, Tmax = 100, Cmin = 0, Cmax = 80;
                const xScale = d3.scaleLinear().domain([Tmin, Tmax]).range([0, plotWidth]);
                const yScale = d3.scaleLinear().domain([Cmin, Cmax]).range([plotHeight, 0]);

                const [mouseX, mouseY] = d3.pointer(event, solubilityPlotSvg.select("g").node());
                if (mouseX >= 0 && mouseX <= plotWidth && mouseY >= 0 && mouseY <= plotHeight) {
                     const T_click = xScale.invert(mouseX);
                     const C_click = yScale.invert(mouseY);
                     solubTempSlider.value = T_click;
                     solubConcSlider.value = C_click;
                     renderSolubilityPlot();
                }
            }
        }

        if (solubTempSlider && solubConcSlider && solubilityPlotContainer) {
            solubTempSlider.addEventListener('input', renderSolubilityPlot);
            solubConcSlider.addEventListener('input', renderSolubilityPlot);
            solubilityPlotContainer.addEventListener('click', updateFromPlotClick);
            window.addEventListener('load', renderSolubilityPlot);
        }

        const nuclSupersatSlider = document.getElementById('nucl-supersat-slider');
        const nuclSupersatValue = document.getElementById('nucl-supersat-value');
        const nuclAgitationSlider = document.getElementById('nucl-agitation-slider');
        const nuclAgitationValue = document.getElementById('nucl-agitation-value');
        const nucleationSvg = d3.select("#nucleation-svg");
        const csdPlotSvg = d3.select("#csd-plot-svg");
        const nucleationOutput = document.getElementById('nucleation-output');

        function updateNucleationVisual() {
            if(!nuclSupersatSlider || !nuclAgitationSlider || nucleationSvg.empty() || csdPlotSvg.empty() || !nucleationOutput) return;
            const supersat = parseInt(nuclSupersatSlider.value);
            const agitation = parseInt(nuclAgitationSlider.value);
            if(nuclSupersatValue) nuclSupersatValue.textContent = supersat;
            if(nuclAgitationValue) nuclAgitationValue.textContent = agitation;

            const B_rel = Math.pow(Math.max(0, supersat - 10) / 90, 2.5) * (1 + agitation / 70);
            const G_rel = Math.max(0.1, (supersat / 100)) * (1 - agitation / 150);

            nucleationSvg.selectAll("*").remove();
            const numNuclei = Math.min(60, Math.max(2, Math.round(B_rel * 100)));
            const meanRadius = Math.max(2, Math.min(18, G_rel * 30));
            const radiusStdDev = meanRadius * (0.2 + B_rel / (G_rel + B_rel + 1e-6) * 0.6);

            const crystalData = [];
            for (let i = 0; i < numNuclei; i++) {
                const r = Math.max(1, d3.randomNormal(meanRadius, radiusStdDev)());
                crystalData.push(r);
                nucleationSvg.append("circle")
                    .attr("cx", Math.random() * 280 + 10)
                    .attr("cy", Math.random() * 180 + 10)
                    .attr("r", r)
                    .attr("class", r < meanRadius * 0.6 ? "nucleus" : "crystal");
            }

            let dominantProcess = "Mixt";
            if (B_rel > G_rel * 1.5) dominantProcess = "Nucleació Dominant";
            else if (G_rel > B_rel * 1.5) dominantProcess = "Creixement Dominant";
            let csdTrend = "Moderada";
            if (B_rel > G_rel) csdTrend = "Fina";
            else if (G_rel > B_rel) csdTrend = "Grossa";
            nucleationOutput.textContent = `Procés: ${dominantProcess}. CSD: ${csdTrend}.`;

            const csdWidth = 300, csdHeight = 100;
            const csdMargin = {top: 5, right: 5, bottom: 20, left: 25};
            const csdPlotWidth = csdWidth - csdMargin.left - csdMargin.right;
            const csdPlotHeight = csdHeight - csdMargin.top - csdMargin.bottom;

            csdPlotSvg.selectAll("*").remove();
            const csdG = csdPlotSvg.append("g").attr("transform", `translate(${csdMargin.left},${csdMargin.top})`);

            const numBins = 10;
            const maxRadius = meanRadius + 3 * radiusStdDev;
            const histogram = d3.histogram().domain([0, maxRadius]).thresholds(numBins);
            const bins = histogram(crystalData);

            const csdXScale = d3.scaleLinear().domain([0, maxRadius]).range([0, csdPlotWidth]);
            const csdYScale = d3.scaleLinear().domain([0, d3.max(bins, d => d.length)]).range([csdPlotHeight, 0]).nice();

            csdG.selectAll("rect")
                .data(bins)
                .enter().append("rect")
                  .attr("x", d => csdXScale(d.x0) + 1)
                  .attr("width", d => Math.max(0, csdXScale(d.x1) - csdXScale(d.x0) - 1))
                  .attr("y", d => csdYScale(d.length))
                  .attr("height", d => csdPlotHeight - csdYScale(d.length))
                  .attr("class", "bar");

             csdG.append("g").attr("transform", `translate(0,${csdPlotHeight})`).call(d3.axisBottom(csdXScale).ticks(5));
             csdG.append("g").call(d3.axisLeft(csdYScale).ticks(3));
             csdG.append("text").attr("transform", `translate(${csdPlotWidth / 2}, ${csdPlotHeight + csdMargin.bottom - 5})`).style("text-anchor", "middle").style("font-size", "8px").text("Mida (L)");
             csdG.append("text").attr("transform", "rotate(-90)").attr("y", 0 - csdMargin.left + 5).attr("x", 0 - (csdPlotHeight / 2)).attr("dy", "0.5em").style("text-anchor", "middle").style("font-size", "8px").text("Nombre (n)");
        }

        if (nuclSupersatSlider && nuclAgitationSlider) {
            nuclSupersatSlider.addEventListener('input', updateNucleationVisual);
            nuclAgitationSlider.addEventListener('input', updateNucleationVisual);
            if(document.getElementById('nucl-temp-slider')) document.getElementById('nucl-temp-slider').addEventListener('input', updateNucleationVisual);
            window.addEventListener('load', updateNucleationVisual);
        }

        const coolingRateSlider = document.getElementById('cooling-rate-slider');
        const coolingRateValue = document.getElementById('cooling-rate-value');
        const coolingNucleationSvg = d3.select("#cooling-nucleation-svg");
        const coolingCsdPlotSvg = d3.select("#cooling-csd-plot-svg");
        const coolingOutput = document.getElementById('cooling-output');

        function updateCoolingVisual() {
            if(!coolingRateSlider || coolingNucleationSvg.empty() || coolingCsdPlotSvg.empty() || !coolingOutput) return;
            const coolingRate = parseInt(coolingRateSlider.value);
            if(coolingRateValue) coolingRateValue.textContent = coolingRate;

            const B_rel_cool = Math.pow(coolingRate / 100, 1.5);
            const G_rel_cool = Math.pow(1 - coolingRate / 100, 0.5);

            coolingNucleationSvg.selectAll("*").remove();
            const numNuclei_cool = Math.min(60, Math.max(5, Math.round(B_rel_cool * 80)));
            const meanRadius_cool = Math.max(2, Math.min(18, G_rel_cool * 20 + 2));
            const radiusStdDev_cool = meanRadius_cool * (0.15 + B_rel_cool / (G_rel_cool + B_rel_cool + 1e-6) * 0.5);

            const crystalData_cool = [];
            for (let i = 0; i < numNuclei_cool; i++) {
                const r = Math.max(1, d3.randomNormal(meanRadius_cool, radiusStdDev_cool)());
                crystalData_cool.push(r);
                coolingNucleationSvg.append("circle")
                    .attr("cx", Math.random() * 280 + 10)
                    .attr("cy", Math.random() * 180 + 10)
                    .attr("r", r)
                    .attr("class", r < meanRadius_cool * 0.6 ? "nucleus" : "crystal");
            }

            let csdTrend_cool = "Moderada";
            if (B_rel_cool > G_rel_cool * 1.2) csdTrend_cool = "Fina/Ampla";
            else if (G_rel_cool > B_rel_cool * 1.2) csdTrend_cool = "Grossa/Estreta";
            coolingOutput.textContent = `Resultat: ${csdTrend_cool}.`;

            const csdWidth = 300, csdHeight = 100;
            const csdMargin = {top: 5, right: 5, bottom: 20, left: 25};
            const csdPlotWidth = csdWidth - csdMargin.left - csdMargin.right;
            const csdPlotHeight = csdHeight - csdMargin.top - csdMargin.bottom;

            coolingCsdPlotSvg.selectAll("*").remove();
            const csdG = coolingCsdPlotSvg.append("g").attr("transform", `translate(${csdMargin.left},${csdMargin.top})`);
            const numBins = 10;
            const maxRadius_cool = meanRadius_cool + 3 * radiusStdDev_cool;
            const histogram_cool = d3.histogram().domain([0, maxRadius_cool]).thresholds(numBins);
            const bins_cool = histogram_cool(crystalData_cool);
            const csdXScale_cool = d3.scaleLinear().domain([0, maxRadius_cool]).range([0, csdPlotWidth]);
            const csdYScale_cool = d3.scaleLinear().domain([0, d3.max(bins_cool, d => d.length)]).range([csdPlotHeight, 0]).nice();

            csdG.selectAll("rect")
                .data(bins_cool)
                .enter().append("rect")
                  .attr("x", d => csdXScale_cool(d.x0) + 1)
                  .attr("width", d => Math.max(0, csdXScale_cool(d.x1) - csdXScale_cool(d.x0) - 1))
                  .attr("y", d => csdYScale_cool(d.length))
                  .attr("height", d => csdPlotHeight - csdYScale_cool(d.length))
                  .attr("class", "bar");
             csdG.append("g").attr("transform", `translate(0,${csdPlotHeight})`).call(d3.axisBottom(csdXScale_cool).ticks(5));
             csdG.append("g").call(d3.axisLeft(csdYScale_cool).ticks(3));
             csdG.append("text").attr("transform", `translate(${csdPlotWidth / 2}, ${csdPlotHeight + csdMargin.bottom - 5})`).style("text-anchor", "middle").style("font-size", "8px").text("Mida (L)");
             csdG.append("text").attr("transform", "rotate(-90)").attr("y", 0 - csdMargin.left + 5).attr("x", 0 - (csdPlotHeight / 2)).attr("dy", "0.5em").style("text-anchor", "middle").style("font-size", "8px").text("Nombre (n)");
        }
         if (coolingRateSlider) {
            coolingRateSlider.addEventListener('input', updateCoolingVisual);
            window.addEventListener('load', updateCoolingVisual);
        }


        const massFSlider = document.getElementById('mass-F-slider');
        const massFValue = document.getElementById('mass-F-value');
        const massxFSlider = document.getElementById('mass-xF-slider');
        const massxFValue = document.getElementById('mass-xF-value');
        const massxMSlider = document.getElementById('mass-xM-slider');
        const massxMValue = document.getElementById('mass-xM-value');
        const massxCInput = document.getElementById('mass-xC-input');
        const massBalanceOutput = document.getElementById('mass-balance-output');
        const leverRuleVis = document.getElementById('lever-rule-vis');

        function updateMassBalance() {
            if(!massFSlider || !massxFSlider || !massxMSlider || !massxCInput || !massBalanceOutput || !leverRuleVis) return;
            const F = parseFloat(massFSlider.value);
            const xF = parseFloat(massxFSlider.value) / 100;
            const xM = parseFloat(massxMSlider.value) / 100;
            const xC = parseFloat(massxCInput.value) / 100;

            if(massFValue) massFValue.textContent = F.toFixed(0);
            if(massxFValue) massxFValue.textContent = (xF * 100).toFixed(0);
            if(massxMValue) massxMValue.textContent = (xM * 100).toFixed(0);

            let C = 0, M = 0, efficacy = 0;
            let leverText = "Regla Palanca: Invàlid (xC ≤ xM o xF < xM)";
            if (xC > xM + 1e-6 && xF >= xM - 1e-6) {
                 C = F * (xF - xM) / (xC - xM);
                 M = F - C;
                 if (F * xF > 1e-6) {
                     efficacy = (C * xC) / (F * xF) * 100;
                 }
                 if (C > 1e-6 && Math.abs(xC - xM) > 1e-6 && Math.abs(xF - xM) > 1e-9) {
                    leverText = `Regla Palanca: M/C = ${(xC - xF).toFixed(3)} / ${(xF - xM).toFixed(3)} ≈ ${(M/C).toFixed(2)}`;
                 } else if (C <= 1e-6) {
                    leverText = "Regla Palanca: No hi ha cristalls (C≈0)";
                 }
            } else {
                M = F;
                C = 0;
                efficacy = 0;
            }
            C = Math.max(0, C);
            M = Math.max(0, M);
            efficacy = Math.max(0, Math.min(100, efficacy));

            massBalanceOutput.textContent = `Cristalls (C): ${C.toFixed(1)} kg | Licor Mare (M): ${M.toFixed(1)} kg | Eficàcia: ${efficacy.toFixed(1)}%`;
            leverRuleVis.textContent = leverText;
        }

        if(massFSlider && massxFSlider && massxMSlider && massxCInput) {
            massFSlider.addEventListener('input', updateMassBalance);
            massxFSlider.addEventListener('input', updateMassBalance);
            massxMSlider.addEventListener('input', updateMassBalance);
            massxCInput.addEventListener('input', updateMassBalance);
            window.addEventListener('load', updateMassBalance);
        }

        const energyFSlider = document.getElementById('energy-F-slider');
        const energyFValue = document.getElementById('energy-F-value');
        const energyTinSlider = document.getElementById('energy-Tin-slider');
        const energyTinValue = document.getElementById('energy-Tin-value');
        const energyToutSlider = document.getElementById('energy-Tout-slider');
        const energyToutValue = document.getElementById('energy-Tout-value');
        const energyHcrystSlider = document.getElementById('energy-Hcryst-slider');
        const energyHcrystValue = document.getElementById('energy-Hcryst-value');
        const energyFeedDisplay = document.getElementById('energy-feed-display');
        const energyCrystalDisplay = document.getElementById('energy-crystal-display');
        const energyLiquorDisplay = document.getElementById('energy-liquor-display');
        const energyQoutDisplay = document.getElementById('energy-qout-display');
        const energyBalanceOutput = document.getElementById('energy-balance-output');

        function updateEnergyBalance() {
            if(!energyFSlider || !energyTinSlider || !energyToutSlider || !energyHcrystSlider || !energyBalanceOutput ||
               !energyFeedDisplay || !energyCrystalDisplay || !energyLiquorDisplay || !energyQoutDisplay) return;

            const F_rel = parseFloat(energyFSlider.value);
            const Tin = parseFloat(energyTinSlider.value);
            const Tout = parseFloat(energyToutSlider.value);
            const Hcryst_rel = parseFloat(energyHcrystSlider.value);

            if(energyFValue) energyFValue.textContent = F_rel.toFixed(0);
            if(energyTinValue) energyTinValue.textContent = Tin.toFixed(0);
            if(energyToutValue) energyToutValue.textContent = Tout.toFixed(0);
            if(energyHcrystValue) energyHcrystValue.textContent = Hcryst_rel.toFixed(0);

            const C_rel = F_rel * 0.4;
            const M_rel = F_rel * 0.6;
            const Cp_liq = 3.5;

            const Q_sensible_F = F_rel * Cp_liq * (Tin - Tout);
            const Q_cryst = C_rel * Hcryst_rel * 5;
            const Q_out = Q_sensible_F + Q_cryst;

            energyFeedDisplay.textContent = `${F_rel.toFixed(0)} @ ${Tin.toFixed(0)}°C`;
            energyCrystalDisplay.textContent = `~${C_rel.toFixed(0)} @ ${Tout.toFixed(0)}°C`;
            energyLiquorDisplay.textContent = `~${M_rel.toFixed(0)} @ ${Tout.toFixed(0)}°C`;
            energyQoutDisplay.textContent = `Q ≈ ${Q_out.toFixed(0)}`;

            let level = "Mitjana";
            if (Q_out < 2000) level = "Baixa";
            else if (Q_out > 6000) level = "Alta";
            energyBalanceOutput.textContent = `Càrrega Refredament (Q) estimada: ${level}`;
        }

         if(energyFSlider && energyTinSlider && energyToutSlider && energyHcrystSlider) {
             energyFSlider.addEventListener('input', updateEnergyBalance);
             energyTinSlider.addEventListener('input', updateEnergyBalance);
             energyToutSlider.addEventListener('input', updateEnergyBalance);
             energyHcrystSlider.addEventListener('input', updateEnergyBalance);
             window.addEventListener('load', updateEnergyBalance);
         }

    </script>

</body>
</html>

